# üìò Gu√≠a de Arquitectura Frontend ‚Äî Agenda M√©dica

### *Referencia primaria del proyecto ‚Äî Siempre revisar antes de crear/modificar c√≥digo*

---

# üß≠ 0. Tabla resumen (Mapa global del proyecto)

| Tipo            | Nombre               | Archivo                         | Descripci√≥n corta                                             |
| --------------- | -------------------- | ------------------------------- | ------------------------------------------------------------- |
| P√°gina          | Agenda de Hoy        | `pages/AgendaSecretaria.tsx`    | Lista del d√≠a, buscador global, cambiar estado, cancelar cita |
| P√°gina          | Nueva Cita           | `pages/NuevaCita.tsx`           | Wizard: paciente ‚Üí doctor ‚Üí fecha ‚Üí horario                   |
| P√°gina          | Pacientes            | `pages/Pacientes.tsx`           | Listado de pacientes + buscador                               |
| P√°gina          | Agenda M√©dico        | `pages/AgendaMedico.tsx`        | Citas del d√≠a filtradas por m√©dico                            |
| P√°gina          | Admin Dashboard      | `pages/AdminDashboard.tsx`      | M√©tricas globales (dummy)                                     |
| P√°gina          | Crear Usuario        | `pages/admin/CreateUser.tsx`    | Formulario para crear usuarios del sistema (solo admin)       |
| Componente      | MainLayout           | `components/MainLayout.tsx`     | Layout + navegaci√≥n principal (role-based)                    |
| Componente      | PatientSearch        | `components/PatientSearch.tsx`  | Buscar/crear paciente inline                                  |
| Componente      | DoctorSearch         | `components/DoctorSearch.tsx`   | Buscar doctor por nombre o especialidad                       |
| Componente      | SlotSelector         | `components/SlotSelector.tsx`   | Selecci√≥n de horario                                          |
| Componente      | AppointmentRow       | `components/AppointmentRow.tsx` | Renderizado compacto de cita                                  |
| Componente      | StatusBadge          | `components/StatusBadge.tsx`    | Etiqueta visual de estado                                     |
| Hook            | useTodayAppointments | `hooks/useTodayAppointments.ts` | Cargar/gestionar citas del d√≠a (con filtro por doctor)        |
| Hook            | usePatientsSearch    | `hooks/usePatientsSearch.ts`    | B√∫squeda de pacientes con debounce                            |
| Hook            | useDoctorsSearch     | `hooks/useDoctorsSearch.ts`     | B√∫squeda de doctores con debounce                             |
| Hook            | useCurrentUser       | `context/UserContext.tsx`       | Acceso al usuario autenticado y roles                         |
| API (servicios) | api.ts               | `lib/api.ts`                    | Router hacia Supabase real o dummy por flag/env               |
| Dummy data      | data.ts, api.dummy.ts| `lib/data.ts`, `lib/api.dummy.ts`| Fuente de data temporal/fallback                             |
| Supabase        | supabaseClient.ts    | `lib/supabaseClient.ts`         | Config inicial (conecta a la BD)                              |
| Tipos           | Appointment          | `types/appointment.ts`          | Modelo de cita                                                |
| Tipos           | Patient              | `types/patient.ts`              | Modelo de paciente                                            |
| Tipos           | Doctor               | `types/doctor.ts`               | M√©dico + especialidad                                         |
| Tipos           | DoctorSchedule       | `types/schedule.ts`             | Agenda del m√©dico                                             |
| Tipos           | CurrentUser          | `types/user.ts`                 | Usuario autenticado con rol                                   |

---

# üîß 1. Convenciones del Proyecto (obligatorias)

- **P√°ginas**: Solo l√≥gica UI, usan hooks y servicios, en `src/pages/`.
- **Servicios/capa API**: `src/lib/api.ts` es el √∫nico entrypoint. NO accedas directo a `api.supabase.ts`.
- **Hooks**: Siempre usan funciones expuestas por `api.ts`.
- **Componentes:** UI m√≠nima, sin fetch, sin l√≥gica de negocio.
- **Tipos:** Definidos en `src/types/`, uno por entidad.

---

# üóÇÔ∏è 2. Capa de Servicios (lib/api.ts, api.supabase.ts, api.dummy.ts)

## 2.1 api.ts (router p√∫blico frontend)

- Expone funciones:  
  `getTodayAppointments`, `getTodayAppointmentsByDoctor`,  
  `updateAppointmentStatus`, `createAppointment`,  
  `getAvailableSlots`, `searchPatients`, `getAllPatients`,  
  `createPatient`, `getSpecialties`, `getDoctorsBySpecialty`, `getDoctors`,  
  `searchDoctors`, `getCurrentUserWithRole`
- Por defecto usa Supabase real (`api.supabase.ts`).
- Permite swap a dummy data (`api.dummy.ts`) por flag/env (`USE_DUMMY_DATA`).
- Los hooks y p√°ginas solo deben importar de aqu√≠.

## 2.2 api.supabase.ts

- Implementaci√≥n real, usa `supabaseClient`.
- Hace queries reales y aplica l√≥gica de negocio¬†(signalado en la gu√≠a backend).

## 2.3 api.dummy.ts

- Implementaci√≥n paralela de las mismas firmas, retorna dummy data para pruebas/local/demo.
- Nunca deber√≠as acceder directo a esto, salvo para tests o si se activa en el router v√≠a flag.

---

# üîå 3. Integraci√≥n actual Supabase

- `.env` contiene claves y URL de Supabase.
- Debes reiniciar Vite si cambias `.env`.
- El frontend ahora consume directamente de la base real por el router de `api.ts`.
- Acceso a datos reales depende tambi√©n de permisos RLS en Supabase (ver gu√≠a backend).

---

# üß™ 4. Hooks

Los hooks de negocio (ej: `useTodayAppointments`, `usePatientsSearch`):

- Usan siempre las funciones p√∫blicas expuestas por `api.ts`.
- No deben importar directo de `api.supabase.ts`.
- Controlan estado (loading, error, data) y reaccionan a cambios del backend.

---

# üß© 5. Dependencias internas y reglas de oro

- Actualiza/crea cualquier funci√≥n nueva siempre primero en `api.supabase.ts` (implementaci√≥n real), luego exp√≥nla en el router (`api.ts`).
- Los componentes y hooks nunca acceden directo a Supabase ni a dummy; siempre al router `api.ts`.
- Si necesitas l√≥gica fuera de lo ya documentado, debes agregarla en el router y documentarla aqu√≠.
- Ap√≥yate en los tipos de `src/types/`.

---

# üöÄ 6. Control de integraci√≥n / testing

- Cuando desarrolles, puedes activar dummy para aislar el frontend de Supabase si lo necesitas.
- Para ambientes reales, confirma que `USE_DUMMY_DATA` est√° en `false` (o vac√≠o).
- Si notas datos vac√≠os, revisa pol√≠ticas RLS, formato de datos y errores de consola.

---

# üìå 7. Notas r√°pidas de migraci√≥n

- El paso a Supabase es transparente para hooks y pantallas existentes si solo usas `api.ts`.
- Si notas datos incongruentes, primero revisa `.env`, el flag de dummy, y pol√≠ticas RLS en tu base.
- Si hay cambios en la estructura de datos, actualiza primero los tipos en `src/types/`.

---

# üìù 8. P√°ginas Principales

## 8.1 Login (`pages/Login.tsx`)
- Autenticaci√≥n con email/password usando Supabase
- Redirecci√≥n autom√°tica a `/agenda-secretaria` tras login exitoso
- Manejo de errores con mensajes amigables

## 8.2 Agenda de Hoy (`pages/AgendaSecretaria.tsx`)
- Lista de citas del d√≠a con buscador global
- Filtro por paciente, m√©dico, tel√©fono o estado
- Cambio de estado inline (dropdown para no canceladas)
- Bot√≥n "Cancelar" por fila (permanente, no reversible)
- Solo accesible para admin y secretary

## 8.3 Nueva Cita (`pages/NuevaCita.tsx`)
- Formulario multi-step en una sola pantalla
- `PatientSearch` con creaci√≥n inline de paciente
- `DoctorSearch` para buscar por nombre o especialidad
- Selector de fecha y `SlotSelector` para horario
- Validaci√≥n antes de crear cita
- Solo accesible para admin y secretary

## 8.4 Agenda M√©dico (`pages/AgendaMedico.tsx`)
- Vista de citas filtradas por m√©dico
- Si es admin: dropdown para seleccionar m√©dico + columna "M√©dico" en tabla
- Si es doctor: solo ve sus propias citas (sin dropdown ni columna)
- Usa `useTodayAppointments(doctorId?)` seg√∫n el rol

## 8.5 Admin Dashboard (`pages/AdminDashboard.tsx`)
- M√©tricas globales: total pacientes, m√©dicos, citas
- Breakdown por estado de cita
- Solo accesible para admin

## 8.6 Crear Usuario (`pages/admin/CreateUser.tsx`)
- Formulario para crear usuarios del sistema
- Campos: email, password, role (admin/secretary/doctor)
- Si role === 'doctor': dropdown para seleccionar m√©dico asociado
- Llamada al edge function `create-user-with-role` de Supabase
- Protecci√≥n de ruta: solo admin puede acceder
- Validaci√≥n de campos requeridos
- Mensajes de √©xito/error con estados visuales
- Deshabilita bot√≥n durante env√≠o

---

# üìù 9. Autenticaci√≥n y Roles

## 9.1 UserContext (`context/UserContext.tsx`)
- Provider global que envuelve toda la app
- Maneja estado de autenticaci√≥n con `supabase.auth.onAuthStateChange`
- Expone `useCurrentUser()` hook con:
  - `user`: objeto `CurrentUser` con id, email, role, doctorId
  - `loading`: boolean para estado de carga
  - `isAdmin`, `isSecretary`, `isDoctor`: flags de rol
  - `isAdminOrSecretary`: flag combinado

## 9.2 ProtectedRoute (en `App.tsx`)
- Wrapper para rutas que requieren autenticaci√≥n
- Redirecciona a `/login` si no hay usuario autenticado
- Muestra "Cargando..." mientras verifica sesi√≥n

## 9.3 MainLayout con roles
- Navegaci√≥n din√°mica seg√∫n rol del usuario:
  - Admin/Secretary: Agenda de Hoy, Nueva Cita, Pacientes, Admin, Crear Usuario
  - Admin/Doctor: Agenda M√©dico
- Bot√≥n "Cerrar sesi√≥n" con `supabase.auth.signOut()`

---

# üìù 10. Componentes de B√∫squeda

## 10.1 PatientSearch
- Input con b√∫squeda debounced (300ms)
- Muestra dropdown con resultados
- Al seleccionar: muestra nombre en el input
- Bot√≥n "Crear nuevo paciente" si no hay resultados
- Creaci√≥n inline de paciente con dialog/sheet

## 10.2 DoctorSearch
- Similar a PatientSearch
- Busca por nombre de doctor o especialidad
- Muestra nombre del doctor + especialidad en resultados
- Al seleccionar: muestra nombre en el input
- Usa `searchDoctors()` del API

---

# üìù 11. Rutas de la Aplicaci√≥n

```tsx
/login                      ‚Üí Login (p√∫blico)
/                          ‚Üí Redirect a /agenda-secretaria (protegido)
/agenda-secretaria         ‚Üí AgendaSecretaria (admin/secretary)
/citas/nueva              ‚Üí NuevaCita (admin/secretary)
/pacientes                ‚Üí Pacientes (admin/secretary)
/agenda-medico            ‚Üí AgendaMedico (admin/doctor)
/admin                    ‚Üí AdminDashboard (admin)
/admin/usuarios/nuevo     ‚Üí CreateUser (admin)
```

---

# üìù 12. Backend: Supabase Edge Functions

El backend de la aplicaci√≥n se implementa mediante Supabase Edge Functions (serverless functions) que manejan l√≥gica de negocio compleja que no puede ejecutarse en el frontend por razones de seguridad.

## 12.1 create-user-with-role

**Ubicaci√≥n**: `supabase/functions/create-user-with-role/`

**Prop√≥sito**: Creaci√≥n robusta de usuarios del sistema (admin/secretary/doctor) desde el panel de administraci√≥n.

**Caracter√≠sticas**:
- Solo accesible por administradores autenticados
- Validaci√≥n completa de inputs (email, password, role, doctorId)
- Creaci√≥n en dos fases: Supabase Auth + tabla public.users
- Limpieza autom√°tica de usuarios hu√©rfanos si falla la inserci√≥n
- Manejo robusto de errores con mensajes claros
- Documentaci√≥n completa en `supabase/functions/create-user-with-role/README.md`

**Uso desde frontend**:
```typescript
const { data, error } = await supabase.functions.invoke('create-user-with-role', {
  body: {
    email: 'nuevo@ejemplo.com',
    password: 'password123',
    role: 'doctor',
    doctorId: 'uuid-del-medico' // Solo si role = doctor
  },
});
```

**Deployment**:
```bash
supabase functions deploy create-user-with-role
```

---

# üìù 13. Changelog (para sincronizaci√≥n interna)

- **2025-11-20**  
  - Implementada Supabase Edge Function `create-user-with-role` para creaci√≥n robusta de usuarios
  - Funci√≥n incluye validaci√≥n JWT, creaci√≥n en Auth + BD, limpieza de hu√©rfanos, y manejo de errores
  - Documentaci√≥n completa agregada en `supabase/functions/create-user-with-role/README.md`
  - Script de pruebas incluido para validaci√≥n manual

- **2025-11-20**  
  - Implementada p√°gina de creaci√≥n de usuarios (`/admin/usuarios/nuevo`)
  - Formulario completo con validaci√≥n y llamada a edge function
  - Protecci√≥n de ruta solo para administradores
  - Agregado link "Crear Usuario" en navegaci√≥n para admin
  - Soporte para asignar doctorId cuando role === 'doctor'

- **2025-11-20**  
  - Implementada b√∫squeda unificada de doctores por nombre o especialidad
  - Componente `DoctorSearch` reemplaza selecci√≥n de especialidad + doctor
  - Hook `useDoctorsSearch` con debounce
  - Funci√≥n `searchDoctors()` agregada al API
  - Actualizado tipo `Doctor` con `specialtyName` opcional

- **2025-11-20**  
  - Implementado sistema de autenticaci√≥n y roles
  - Contexto global `UserContext` con `useCurrentUser` hook
  - P√°gina de login con Supabase Auth
  - Rutas protegidas con redirecci√≥n a login
  - Navegaci√≥n din√°mica basada en roles
  - Funci√≥n `getCurrentUserWithRole()` en API

- **2025-11-19**  
  - Migraci√≥n a Supabase terminada: `api.ts` ahora es proxy/router, dummy data vive en `api.dummy.ts`.
  - Hooks y componentes siguen funcionando sin cambios.
  - Gu√≠a alineada con capa de servicios real y dummy.

---

*Si agregas o modificas flujos, documenta siempre aqu√≠ y sincroniza con el Documento Maestro (`Proyecto_contexto_maestro.md`).*
